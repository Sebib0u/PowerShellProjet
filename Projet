<#
.SYNOPSIS
Création et gestion de GPO.
.DESCRIPTION
Ce script permet de créer trois GPO (Wallpaper, Verouillage de compte et politique de mdp), d'exporté leur rapport dans un dossier, de faire une backup général si besoin.
#>


#Crée une GPO qui permet de changer de fond d'écran.
    $reponse1 = Read-Host -Prompt "Voulez-vous attribuer un font d'écran Lié à une OU spécifique ? (Oui/Non)"
    if ($reponse1 -like 'Oui')
    {
    $GPOname = 'Wallpaper'
    #Créer la GPO.
    New-GPO -Name $GPOname
    #Configurer la GPO.
    Set-GpRegistryValue -Name $GPOname -key "HKEY_CURRENT_USER\Control Panel\Desktop" -ValueName "Wallpaper" -type string -value "C:\Wallpaper\283763.jpg"
    #Permet de linker vers l'OU, a changer le lien "Target"
    New-GPLink -Name $GPOname -Target "ou=general,dc=seb,dc=com" -LinkEnabled Yes
    Gpupdate /force
    }

#Verrouiller le compte après un certain nombre d'erreurs.
#demander si l'utilisateur veux faire en sorte de vérouillez un compte après un certain nombre d'erreurs.
$reponse2 = Read-Host -Prompt "Voulez-vous faire en sorte de bloquer un utilisateur après un certain nombre d'erreurs (Oui/Non) ? "
if(reponse2 -like 'Oui')
    {
    #demander le nombres d'erreurs.
    $numberOfErrors = Read-Host -Prompt "A partir de combien d'erreurs voulez vous bloquer l'utilisateur ? "
    #Demander le temps de verouillage en secondes.
    $TimeOfBan = Read-Host -Prompt "Pendant combien de temps (secondes) ? "
    $GPO2name = 'locking'
    #Créer la GPO.
     New-GPO -Name $GPO2name 
    $LockoutKey = "System\AccountLockoutPolicy"
    #Configuration de la GPO.
    Set-GPRegistryValue -Name locking.DisplayName -Key $LockoutKey -ValueName "LockoutThreshold" -Type DWORD -Value $numberOfErrors
    Set-GPRegistryValue -Name locking.DisplayName -Key $LockoutKey -ValueName "LockoutDuration" -Type DWORD -Value $TimeOfBan
    Set-GPRegistryValue -Name locking.DisplayName -Key $LockoutKey -ValueName "ResetLockoutCount" -Type DWORD -Value $TimeOfBan
    #Relier la GPO à l'OU.
    New-GPLink -Name $GPO2name -Target "ou=general,dc=seb,dc=com" -LinkEnabled Yes
    Gpupdate /force
    }


#Changement de la politique de MDP.
#Demander si l'utilisateur désire changer ça politique de MDP.
$reponse3 = Read-Host -Prompt "Voulez-vous changer votre politique de mot de passe ? (Oui / Non) "
if($reponse3 -like 'Oui')
    {
    $GPO3name = 'PolitiqueChange'
    #Créer la GPO.
    New-GPO -Name $GPO3name 
    $GPO = Get-GPO -name $GPO3name
    #Configurer la GPO.
    Set-GPRegistryValue -Name $GPO.DisplayName -key "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" -ValueName "MinimumPasswordLength" -Type DWord -Value 14
    #Relier la GPO à l'OU.
    New-GPLink -Name $GPO3name -Target "ou=general,dc=seb,dc=com" -LinkEnabled Yes
    Gpupdate /force
    }


# Demande si besoin de créer un rapport. si oui, demande qu'elle extension est désiré (HTML ou XML) puis crée un dossier nommé report et pour finir inserera le rapport dedans.  
$rapport = Read-Host -Prompt "Voulez-vous créer un rapport ? (Oui/Non)"
if ($rapport -like 'Oui')
{
    $nom = Read-Host -Prompt "Inserez le nom de votre GPO "
    $Format = Read-Host -Prompt "Inserez le format (Html/Xml) "
    if($Format -like 'Html')
    {
        New-Item "C:\Report" -itemType Directory
        Get-GPOReport -Name $nom -ReportType Html -Path c:\Report\Report.html
    }
    else
    {
        New-Item "C:\Report" -itemType Directory
        Get-GPOReport -Name $nom -ReportType Xml -Path c:\Report\Report.xml
    }
}

#Demande si un backup de toutes les GPO est nésessaire. Si oui, Crée un dossier nommé Backup et l'inserera dedans.
$reponse2 = Read-Host -Prompt "Voulez-vous faire une backup de vos GPO ? (Oui/Non)"

if ($reponse2 -like 'Oui')
{
    New-Item "C:\GPOBackup" -itemType Directory
    Get-GPO -All | Backup-GPO -Path C:\GPOBackup\ -Comment "$(Get-Date)"
}



